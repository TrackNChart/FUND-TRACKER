<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Expense & Budget Tracker</title>

  <!-- Tailwind + Chart.js -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* Embedded accounting-themed SVG wallpaper (no external image required) */
    body {
      min-height: 100vh;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background-color: #e6f2ff;
      background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='360' height='360' viewBox='0 0 360 360'><rect width='100%25' height='100%25' fill='%23cfe9ff' /><g opacity='0.14'><rect x='18' y='18' width='60' height='80' rx='6' fill='%23000' /><circle cx='45' cy='120' r='18' fill='%23000' /><rect x='100' y='10' width='140' height='80' rx='8' fill='%23000' /><path d='M120 80 L160 40 L200 70 L240 30' stroke='%23000' stroke-width='6' fill='none' stroke-linecap='round' stroke-linejoin='round' /></g><g opacity='0.06'><rect x='260' y='250' width='70' height='70' rx='8' fill='%23000' /><circle cx='295' cy='280' r='22' fill='%23000' /></g></svg>");
      background-repeat: repeat;
      background-size: 360px 360px;
    }

    .glass {
      background: rgba(255,255,255,0.88);
      backdrop-filter: blur(6px);
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(2,6,23,0.12);
    }

    header { position: relative; }
    #logout-btn { position: absolute; right: 1rem; top: 1rem; }

    /* Small helpers */
    .card { padding: 1rem; border-radius: 10px; }
  </style>
</head>
<body class="p-6">

  <!-- Header -->
  <header class="glass p-6 mb-6">
    <div class="flex items-center justify-between">
      <h1 class="text-2xl font-semibold">ðŸ’° Expense & Budget Tracker</h1>
      <button id="logout-btn" class="hidden bg-red-600 text-white px-3 py-2 rounded hover:bg-red-700">Log out</button>
    </div>
  </header>

  <!-- Auth area -->
  <section id="auth-area" class="max-w-md mx-auto glass p-6 mb-6">
    <h2 id="auth-title" class="text-xl font-semibold mb-4">Log In</h2>

    <!-- Login form -->
    <form id="login-form" class="space-y-3">
      <input id="login-username" class="w-full p-2 border rounded" placeholder="Username" required />
      <input id="login-password" class="w-full p-2 border rounded" placeholder="Password" type="password" required />
      <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">Log In</button>
      <p class="text-sm text-center mt-2">Don't have an account? <a href="#" id="to-signup" class="text-blue-600 underline">Sign up</a></p>
      <p id="auth-msg" class="text-sm text-red-600 mt-2"></p>
    </form>

    <!-- Signup form (hidden) -->
    <form id="signup-form" class="space-y-3 hidden">
      <input id="signup-username" class="w-full p-2 border rounded" placeholder="Choose username" required />
      <input id="signup-password" class="w-full p-2 border rounded" placeholder="Choose password" type="password" required />
      <button type="submit" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700">Sign up</button>
      <p class="text-sm text-center mt-2">Already have an account? <a href="#" id="to-login" class="text-blue-600 underline">Log in</a></p>
      <p id="signup-msg" class="text-sm text-red-600 mt-2"></p>
    </form>
  </section>

  <!-- Dashboard -->
  <main id="dashboard" class="hidden max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Left column -->
    <div class="space-y-6">
      <div class="glass card">
        <h3 class="text-lg font-semibold mb-3">Set Budget</h3>
        <input id="budget-input" type="number" class="w-full p-2 border rounded mb-3" placeholder="Enter budget (â‚±)" />
        <button id="set-budget" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700">Set Budget</button>
        <p id="budget-display" class="mt-3 font-semibold">Budget: â‚±0.00</p>
      </div>

      <div class="glass card">
        <h3 class="text-lg font-semibold mb-3">Summary</h3>
        <p id="total-expenses">Total Expenses: â‚±0.00</p>
        <p id="remaining-budget" class="font-semibold">Remaining Budget: â‚±0.00</p>
        <hr class="my-3" />
        <p id="monthly-total">Monthly Expenses: â‚±0.00</p>
        <p id="annual-total">Annual Expenses: â‚±0.00</p>
        <button id="reset-btn" class="mt-4 w-full bg-red-500 text-white py-2 rounded hover:bg-red-600">Reset Tracker</button>
      </div>
    </div>

    <!-- Middle column -->
    <div class="space-y-6">
      <div class="glass card">
        <h3 class="text-lg font-semibold mb-3">Add Expense</h3>
        <input id="expense-name" class="w-full p-2 border rounded mb-2" placeholder="Expense name" />
        <input id="expense-amount" class="w-full p-2 border rounded mb-2" placeholder="Amount" type="number" />
        <input id="expense-date" class="w-full p-2 border rounded mb-2" type="date" />
        <select id="expense-category" class="w-full p-2 border rounded mb-2">
          <option value="Food">Food</option>
          <option value="Transport">Transport</option>
          <option value="Bills">Bills</option>
          <option value="Shopping">Shopping</option>
          <option value="Other">Other</option>
        </select>
        <div class="flex gap-2">
          <button id="add-expense" class="flex-1 bg-blue-600 text-white py-2 rounded hover:bg-blue-700">Add</button>
          <button id="export-csv" class="flex-1 bg-gray-700 text-white py-2 rounded hover:bg-gray-800">Export CSV</button>
        </div>
      </div>

      <div class="glass card max-h-64 overflow-auto">
        <h3 class="text-lg font-semibold mb-3">Expenses</h3>
        <ul id="expense-list" class="space-y-2 text-sm"></ul>
      </div>
    </div>

    <!-- Right column: charts -->
    <div class="space-y-6">
      <div class="glass card">
        <h3 class="text-lg font-semibold mb-3">Category Breakdown</h3>
        <div style="height:220px;">
          <canvas id="pieChart"></canvas>
        </div>
      </div>

      <div class="glass card">
        <h3 class="text-lg font-semibold mb-3">Monthly Expenses (This Year)</h3>
        <div style="height:220px;">
          <canvas id="barChart"></canvas>
        </div>
      </div>
    </div>
  </main>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // ---- state ----
  let users = JSON.parse(localStorage.getItem('users') || '{}');
  let currentUser = null;
  let budget = 0;
  let expenses = [];
  const categoriesList = ['Food','Transport','Bills','Shopping','Other'];

  // ---- DOM refs ----
  const authArea = document.getElementById('auth-area');
  const loginForm = document.getElementById('login-form');
  const signupForm = document.getElementById('signup-form');
  const toSignup = document.getElementById('to-signup');
  const toLogin = document.getElementById('to-login');
  const authMsg = document.getElementById('auth-msg');
  const signupMsg = document.getElementById('signup-msg');

  const dashboard = document.getElementById('dashboard');
  const logoutBtn = document.getElementById('logout-btn');

  const budgetInput = document.getElementById('budget-input');
  const setBudgetBtn = document.getElementById('set-budget');
  const budgetDisplay = document.getElementById('budget-display');

  const expenseName = document.getElementById('expense-name');
  const expenseAmount = document.getElementById('expense-amount');
  const expenseDate = document.getElementById('expense-date');
  const expenseCategory = document.getElementById('expense-category');
  const addExpenseBtn = document.getElementById('add-expense');
  const exportCsvBtn = document.getElementById('export-csv');

  const expenseListEl = document.getElementById('expense-list');

  const totalExpensesEl = document.getElementById('total-expenses');
  const remainingBudgetEl = document.getElementById('remaining-budget');
  const monthlyTotalEl = document.getElementById('monthly-total');
  const annualTotalEl = document.getElementById('annual-total');

  // ---- charts ----
  const pieCtx = document.getElementById('pieChart').getContext('2d');
  const barCtx = document.getElementById('barChart').getContext('2d');

  const pieChart = new Chart(pieCtx, {
    type: 'pie',
    data: {
      labels: categoriesList,
      datasets: [{ data: Array(categoriesList.length).fill(0), backgroundColor: ['#3b82f6','#10b981','#f59e0b','#ef4444','#6366f1'] }]
    },
    options: { responsive: true, maintainAspectRatio: false }
  });

  const barChart = new Chart(barCtx, {
    type: 'bar',
    data: {
      labels: ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'],
      datasets: [{ label: 'Monthly (â‚±)', data: Array(12).fill(0), backgroundColor: '#3b82f6' }]
    },
    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
  });

  // ---- helpers ----
  function saveUsers() { localStorage.setItem('users', JSON.stringify(users)); }

  function showAuth(msg='') {
    authArea.classList.remove('hidden');
    dashboard.classList.add('hidden');
    logoutBtn.classList.add('hidden');
    authMsg.textContent = msg;
  }

  function showDashboard() {
    authArea.classList.add('hidden');
    dashboard.classList.remove('hidden');
    logoutBtn.classList.remove('hidden');
    // default date for expense date input
    expenseDate.valueAsDate = new Date();
    // ensure charts render correctly after being unhidden
    pieChart.update();
    barChart.update();
  }

  function resetLocalStateFromUser() {
    if (!currentUser || !users[currentUser]) {
      budget = 0; expenses = []; return;
    }
    const data = users[currentUser].data || { budget:0, expenses: [], categories: {} };
    budget = Number(data.budget || 0);
    // normalize expenses to shape: {name, amount, date (ISO), category}
    expenses = Array.isArray(data.expenses) ? data.expenses.map(e => ({ name: e.name, amount: Number(e.amount), date: e.date, category: e.category })) : [];
    // ensure categories totals exist
    const catTotals = {};
    categoriesList.forEach(c => catTotals[c] = 0);
    (expenses || []).forEach(e => { if (catTotals[e.category] !== undefined) catTotals[e.category] += Number(e.amount); });
    users[currentUser].data = { budget, expenses, categories: catTotals };
    saveUsers();
  }

  function saveUserData() {
    if (!currentUser) return;
    // compute fresh category totals
    const catTotals = {};
    categoriesList.forEach(c => catTotals[c] = 0);
    expenses.forEach(e => { if (catTotals[e.category] !== undefined) catTotals[e.category] += Number(e.amount); });
    users[currentUser].data = { budget, expenses, categories: catTotals };
    saveUsers();
  }

  function renderExpenseList() {
    expenseListEl.innerHTML = '';
    // show newest first
    const sorted = expenses.slice().sort((a,b) => new Date(b.date) - new Date(a.date));
    sorted.forEach((e, idxSorted) => {
      const originalIndex = expenses.findIndex(x => x.name===e.name && x.date===e.date && Number(x.amount)===Number(e.amount) && x.category===e.category);
      const li = document.createElement('li');
      li.className = 'flex items-center justify-between bg-gray-100 p-2 rounded';
      const left = document.createElement('div');
      left.innerHTML = `<div class="font-medium">${escapeHtml(e.name)}</div><div class="text-xs text-gray-600">${(new Date(e.date)).toLocaleDateString()} â€¢ â‚±${Number(e.amount).toFixed(2)} â€¢ ${escapeHtml(e.category)}</div>`;
      const right = document.createElement('div');
      right.innerHTML = `<button class="edit text-xs bg-yellow-400 px-2 py-1 rounded mr-2">Edit</button><button class="del text-xs bg-red-500 text-white px-2 py-1 rounded">Delete</button>`;
      li.appendChild(left);
      li.appendChild(right);
      expenseListEl.appendChild(li);

      // Delete handler
      right.querySelector('.del').addEventListener('click', () => {
        expenses.splice(originalIndex, 1);
        saveUserData();
        updateAllUI();
      });

      // Edit handler (opens a small prompt flow)
      right.querySelector('.edit').addEventListener('click', () => {
        // prefill a prompt-style edit (could be replaced by a nicer modal)
        const newName = prompt('Edit name', e.name);
        if (newName === null) return; // cancel
        const newAmountRaw = prompt('Edit amount', e.amount);
        if (newAmountRaw === null) return;
        const newAmount = Number(newAmountRaw);
        if (Number.isNaN(newAmount) || newAmount < 0) { alert('Invalid amount'); return; }
        const newDateRaw = prompt('Edit date (YYYY-MM-DD)', e.date.slice(0,10));
        if (newDateRaw === null) return;
        const newDate = new Date(newDateRaw);
        if (isNaN(newDate)) { alert('Invalid date'); return; }
        const newCategory = prompt('Edit category (Food, Transport, Bills, Shopping, Other)', e.category) || e.category;
        // apply
        expenses[originalIndex] = { name: newName, amount: newAmount, date: newDate.toISOString(), category: categoriesList.includes(newCategory) ? newCategory : 'Other' };
        saveUserData();
        updateAllUI();
      });
    });
  }

  function updateCharts() {
    // category totals
    const catTotals = categoriesList.map(c => 0);
    expenses.forEach(e => {
      const i = categoriesList.indexOf(e.category);
      if (i >= 0) catTotals[i] += Number(e.amount);
    });
    pieChart.data.datasets[0].data = catTotals;
    pieChart.update();

    // monthly totals for current year
    const thisYear = (new Date()).getFullYear();
    const monthly = Array(12).fill(0);
    expenses.forEach(e => {
      const d = new Date(e.date);
      if (!isNaN(d) && d.getFullYear() === thisYear) monthly[d.getMonth()] += Number(e.amount);
    });
    barChart.data.datasets[0].data = monthly;
    barChart.update();
  }

  function updateSummary() {
    const total = expenses.reduce((s, e) => s + Number(e.amount), 0);
    totalExpensesEl.textContent = `Total Expenses: â‚±${total.toFixed(2)}`;
    remainingBudgetEl.textContent = `Remaining Budget: â‚±${(budget - total).toFixed(2)}`;

    const now = new Date();
    const monthTotal = expenses.filter(e => { const d = new Date(e.date); return !isNaN(d) && d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear(); }).reduce((s,e)=>s+Number(e.amount), 0);
    const yearTotal = expenses.filter(e => { const d = new Date(e.date); return !isNaN(d) && d.getFullYear() === now.getFullYear(); }).reduce((s,e)=>s+Number(e.amount), 0);
    monthlyTotalEl.textContent = `Monthly Expenses: â‚±${monthTotal.toFixed(2)}`;
    annualTotalEl.textContent = `Annual Expenses: â‚±${yearTotal.toFixed(2)}`;
  }

  function updateAllUI() {
    renderExpenseList();
    updateSummary();
    updateCharts();
    budgetDisplay.textContent = `Budget: â‚±${Number(budget || 0).toFixed(2)}`;
  }

  // small escape to avoid injection in innerHTML usage
  function escapeHtml(s) { return String(s).replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch])); }

  // ---- auth handlers ----
  toSignup.addEventListener('click', (e)=>{ e.preventDefault(); loginForm.classList.add('hidden'); signupForm.classList.remove('hidden'); authMsg.textContent=''; });
  toLogin.addEventListener('click', (e)=>{ e.preventDefault(); signupForm.classList.add('hidden'); loginForm.classList.remove('hidden'); signupMsg.textContent=''; });

  // Login submit
  loginForm.addEventListener('submit', (ev) => {
    ev.preventDefault();
    const username = document.getElementById('login-username').value.trim();
    const password = document.getElementById('login-password').value;
    if (!username || !password) { authMsg.textContent = 'Enter username and password.'; return; }
    if (!users[username] || users[username].password !== password) { authMsg.textContent = 'Invalid username or password.'; return; }
    currentUser = username;
    resetLocalStateFromUser();
    showDashboard();
    updateAllUI();
    authMsg.textContent = '';
    console.log('Logged in as', currentUser);
  });

  // Signup submit
  signupForm.addEventListener('submit', (ev) => {
    ev.preventDefault();
    const username = document.getElementById('signup-username').value.trim();
    const password = document.getElementById('signup-password').value;
    if (!username || !password) { signupMsg.textContent = 'Enter username and password.'; return; }
    if (users[username]) { signupMsg.textContent = 'Username already exists.'; return; }
    // initialize user structure
    users[username] = { password, data: { budget:0, expenses:[], categories: categoriesList.reduce((o,c)=> (o[c]=0,o), {}) } };
    saveUsers();
    signupMsg.textContent = 'Account created. Please log in.';
    // switch to login
    signupForm.reset();
    signupForm.classList.add('hidden');
    loginForm.classList.remove('hidden');
  });

  // logout
  logoutBtn.addEventListener('click', () => {
    currentUser = null;
    showAuth('You have been logged out.');
  });

  // ---- tracker handlers ----
  setBudgetBtn.addEventListener('click', () => {
    const val = Number(budgetInput.value) || 0;
    budget = val;
    saveUserData();
    updateAllUI();
  });

  addExpenseBtn.addEventListener('click', () => {
    if (!currentUser) { alert('Please log in'); return; }
    const name = expenseName.value.trim();
    const amount = Number(expenseAmount.value);
    const dateVal = expenseDate.value ? new Date(expenseDate.value) : new Date();
    const category = expenseCategory.value || 'Other';
    if (!name || isNaN(amount) || amount <= 0) { alert('Enter valid name and amount.'); return; }
    const iso = dateVal.toISOString();
    expenses.push({ name, amount, date: iso, category });
    // save & update
    saveUserData();
    expenseName.value = '';
    expenseAmount.value = '';
    expenseDate.valueAsDate = new Date();
    updateAllUI();
  });

  // Delete / Edit implemented in renderExpenseList

  // Reset
  document.getElementById('reset-btn').addEventListener('click', () => {
    if (!currentUser) return alert('Please log in');
    if (!confirm('Reset budget and all expenses for this account?')) return;
    budget = 0;
    expenses = [];
    saveUserData();
    updateAllUI();
  });

  // Export CSV
  exportCsvBtn.addEventListener('click', () => {
    if (!currentUser) return alert('Please log in');
    if (!expenses.length) return alert('No expenses to export.');
    const header = ['date','name','category','amount'];
    const rows = expenses.map(e => [e.date.slice(0,10), e.name, e.category, Number(e.amount).toFixed(2)]);
    const csv = [header, ...rows].map(r => r.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${currentUser}_expenses.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  // ---- init UI ----
  showAuth();

  // prefill today's date input if exists
  if (document.getElementById('expense-date')) document.getElementById('expense-date').valueAsDate = new Date();
});
</script>
</body>
</html>
